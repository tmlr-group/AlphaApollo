<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Trajectory Viewer (Advanced)</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMckDMOe6bv2QrqoFRCwW3xidGZOzYhMVGbBIe7gK4GylBIJb" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    
    <!-- marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Chart.js and datalabels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f9fafb;
            padding-top: 64px; /* Offset for fixed navbar */
        }
        .katex .boxed {
            padding: 0.5em; border: 2px solid #34d399; border-radius: 0.375rem; background-color: #f0fdf4;
        }
        .prose { max-width: none; overflow-wrap: break-word; word-wrap: break-word; white-space: pre-wrap; line-height: 1.6; }
        .prose pre { white-space: pre-wrap; word-break: break-all; }
        
        #selection-grid-container {
            overflow: auto;
            max-height: 60vh;
        }
        #selection-grid {
            display: grid;
            cursor: cell;
        }
        .grid-cell {
            padding: 0.5rem; text-align: center; border: 1px solid #e5e7eb; background-color: #f9fafb;
            display: flex; align-items: center; justify-content: center; font-size: 0.875rem;
        }
        .grid-header { background-color: #f3f4f6; font-weight: 600; position: sticky; top: 0; z-index: 20; }
        .grid-row-header { background-color: #f3f4f6; font-weight: 600; position: sticky; left: 0; z-index: 10; min-width: 100px; }
        .grid-cell.selected { background-color: #93c5fd; border-color: #3b82f6; }
        .grid-cell.selectable:hover { background-color: #dbeafe; }
        .ai-summary-content h3 { font-size: 1.1em; font-weight: 600; margin-top: 0.8em; margin-bottom: 0.4em; }

        /* Notion-style collapsible lists */
        details {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }
        details > summary {
            list-style: none;
            cursor: pointer;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            background-color: #f9fafb;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }
        details[open] > summary {
             border-bottom-color: #e5e7eb;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        .collapsible-content {
            padding: 1rem;
            background-color: white;
        }
        .collapsible-icon {
            transition: transform 0.2s ease-in-out;
            width: 1.25rem;
            height: 1.25rem;
        }
        details:not([open]) .collapsible-icon {
            transform: rotate(-90deg);
        }
        .toggle-bg { transition: background-color .2s ease-in-out; }
        .dot { transition: transform .2s ease-in-out; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Top Navigation Bar -->
    <nav class="bg-white/80 backdrop-blur-md shadow-sm fixed top-0 left-0 right-0 z-50 border-b border-gray-200">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="font-bold text-xl text-gray-800">Model Viewer</span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#global-stats-section" id="nav-stats" class="text-gray-600 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium hidden">Global Stats</a>
                        <a href="#response-filter-section" id="nav-response" class="text-gray-600 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium hidden">Model Responses</a>
                        <a href="#ai-summary-section" id="nav-summary" class="text-gray-600 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium hidden">AI Summary & Score</a>
                        <a href="#selection-export-section" id="nav-export" class="text-gray-600 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium hidden">Select & Export</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header Section -->
        <header id="header-section" class="bg-white p-6 rounded-xl shadow-md mb-8 border border-gray-200">
            <h1 class="text-3xl font-bold text-gray-900">Model Trajectory Viewer</h1>
            <p class="text-gray-600 mt-2">Import a JSONL file to view, analyze, and filter the model's problem-solving trajectories and tool usage.</p>
            <div class="flex items-center mt-4 space-x-4">
                <label for="fileInput" class="inline-block cursor-pointer shrink-0">
                    <span class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-sm">Select File</span>
                    <input type="file" id="fileInput" accept=".jsonl" class="hidden"/>
                </label>
                <select id="trajectory-select" class="w-full lg:w-1/2 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="-1" disabled selected>Please select a file first</option>
                </select>
            </div>
            <p id="fileName" class="text-sm text-gray-500 mt-2 ml-1"></p>

        </header>

        <!-- Global Statistics Section -->
        <div id="global-stats-section" class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Global Statistics Analysis</h2>
            <div class="mb-12">
                <h3 class="font-semibold text-lg text-gray-800 mb-2 text-center">Per-Question Correctness Rate</h3>
                <p class="text-sm text-gray-500 text-center mb-2">(Click on a bar to jump to that question)</p>
                <div class="h-96 w-full">
                     <canvas id="per-question-correctness-chart"></canvas>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-12">
                <div>
                    <h3 class="font-semibold text-lg text-gray-800 mb-2 text-center">Correctness Rate Distribution</h3>
                    <canvas id="correctness-rate-chart"></canvas>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-gray-800 mb-2 text-center">Average Tool Usage Comparison</h3>
                    <canvas id="avg-tool-usage-chart"></canvas>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-gray-800 mb-2 text-center">Python Executor Usage Distribution</h3>
                    <canvas id="global-python-chart"></canvas>
                </div>
                <div>
                    <h3 id="secondary-tool-dist-title" class="font-semibold text-lg text-gray-800 mb-2 text-center"></h3>
                    <canvas id="global-secondary-tool-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Trajectory Detail View -->
        <div id="trajectory-detail" class="bg-white p-6 rounded-xl shadow-md border border-gray-200 min-h-[60vh]">
             <div class="text-center text-gray-500 flex flex-col justify-center items-center h-full min-h-[60vh]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">Select a Trajectory</h3>
                <p class="mt-1 text-sm text-gray-500">Upload a file and choose a trajectory from the dropdown to see its details.</p>
            </div>
        </div>
        
        <!-- Selection and Export Section -->
        <div id="selection-export-section" class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mt-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">Select & Export Responses</h2>
                <div class="flex space-x-4">
                    <button id="clear-selection-button" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors shadow-sm">Clear Selection</button>
                    <button id="export-button" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-sm">Export Selected</button>
                </div>
            </div>
            <p class="text-gray-600 mb-4">Click or drag your mouse on the grid below to select cells for export.</p>
            <div id="selection-grid-container"></div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let allTrajectories = [];
        let chartInstances = {};
        let selectionState = new Set();
        let isDragging = false;
        let dragStartCell = { row: -1, col: -1 };
        let secondaryToolName = 'rag_system_retrieve'; 
        let secondaryToolConfig = {
            'rag_system_retrieve': { label: 'RAG', displayName: 'RAG System Retrieve' },
            'chat_with_repository': { label: 'Repo', displayName: 'Chat with Repository' },
            'query_package_rag': { label: 'PkgRAG', displayName: 'Query Package RAG' },
            'wiki': { label: 'Wiki', displayName: 'Wiki Search' }
        };
        let customApiModelConfig = { baseUrl: '', apiKey: '', modelName: '' };

        // --- DOM Elements ---
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');
        const trajectorySelect = document.getElementById('trajectory-select');
        const trajectoryDetailContainer = document.getElementById('trajectory-detail');
        const selectionExportSection = document.getElementById('selection-export-section');
        const exportButton = document.getElementById('export-button');
        const clearSelectionButton = document.getElementById('clear-selection-button');
        const globalStatsSection = document.getElementById('global-stats-section');
        const navLinks = {
            stats: document.getElementById('nav-stats'),
            response: document.getElementById('nav-response'),
            summary: document.getElementById('nav-summary'),
            export: document.getElementById('nav-export'),
        };

        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFileSelect);
        trajectorySelect.addEventListener('change', (e) => {
            displayTrajectoryDetail(e.target.value);
            // Add a small delay to ensure the element is rendered before scrolling
            setTimeout(() => {
                const responseSection = document.getElementById('response-filter-section');
                if (responseSection) {
                    responseSection.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100); 
        });
        exportButton.addEventListener('click', exportSelections);
        clearSelectionButton.addEventListener('click', clearSelection);
        
        // Register Chart.js datalabels plugin globally
        Chart.register(ChartDataLabels);

        function getToolConfig() {
            return secondaryToolConfig[secondaryToolName] || { label: 'Tool', displayName: 'Unknown Tool' };
        }

        function detectSecondaryTool(trajectories) {
            const fileContent = JSON.stringify(trajectories);
            if (fileContent.includes('"rag_system_retrieve"')) return 'rag_system_retrieve';
            if (fileContent.includes('"chat_with_repository"')) return 'chat_with_repository';
            if (fileContent.includes('"query_package_rag"')) return 'query_package_rag';
            if (fileContent.includes('"wiki"')) return 'wiki';
            return 'rag_system_retrieve'; // Default
        }

        function countToolCalls(responseString) {
            const counts = { python: 0, secondary: 0 };
            if (!responseString) return counts;
            const regex = /<tool_call>([\s\S]*?)<\/tool_call>/g;
            let match;
            while ((match = regex.exec(responseString)) !== null) {
                try {
                    const jsonContent = JSON.parse(match[1]);
                    if (jsonContent.name === 'python_code_executor') counts.python++;
                    else if (jsonContent.name === secondaryToolName) counts.secondary++;
                } catch (e) { /* Silently ignore parsing errors */ }
            }
            return counts;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            fileNameDisplay.textContent = `Selected: ${file.name}`;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    allTrajectories = lines.map(line => JSON.parse(line));
                    secondaryToolName = detectSecondaryTool(allTrajectories);
                    allTrajectories.forEach(traj => {
                        traj.tool_counts = (traj.responses || []).map(resp => countToolCalls(resp));
                    });

                    renderTrajectoryList();
                    renderSelectionGrid(); 
                    renderGlobalStats();
                    
                    selectionExportSection.classList.remove('hidden');
                    globalStatsSection.classList.remove('hidden');
                    Object.values(navLinks).forEach(link => link.classList.remove('hidden'));

                    trajectoryDetailContainer.innerHTML = `<div class="text-center text-gray-500 flex flex-col justify-center items-center h-full min-h-[60vh]"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><h3 class="mt-4 text-lg font-medium text-gray-900">Select a Trajectory from the Dropdown</h3><p class="mt-1 text-sm text-gray-500">The detailed problem-solving steps will be displayed here.</p></div>`;
                } catch (error) {
                    console.error("Error parsing file:", error);
                    selectionExportSection.classList.add('hidden');
                    globalStatsSection.classList.add('hidden');
                    Object.values(navLinks).forEach(link => link.classList.add('hidden'));
                    trajectoryDetailContainer.innerHTML = `<div class="text-center text-red-700 p-10 bg-red-100 rounded-lg"><p>Failed to parse file. Please ensure it is a valid JSONL format.</p><p class="text-sm mt-2">${error.message}</p></div>`;
                }
            };
            reader.readAsText(file);
        }

        function renderTrajectoryList() {
            trajectorySelect.innerHTML = '<option value="-1" disabled selected>Select a trajectory...</option>';
            if (allTrajectories.length === 0) {
                trajectorySelect.innerHTML = '<option value="-1" disabled selected>No trajectories found in file</option>';
                return;
            }
            allTrajectories.forEach((traj, index) => {
                const option = document.createElement('option');
                option.value = index;
                const questionText = traj.extra_info?.question || `Trajectory ${index + 1}`;
                option.textContent = `ID: ${traj.id || index} - ${questionText.substring(0, 80)}...`;
                trajectorySelect.appendChild(option);
            });
        }
        
        function renderSelectionGrid() {
            const container = document.getElementById('selection-grid-container');
            if (!container || allTrajectories.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No data available to select.</p>';
                return;
            }
            
            selectionState.clear();
            const maxResponses = Math.max(0, ...allTrajectories.map(t => t.responses?.length || 0));
            
            const grid = document.createElement('div');
            grid.id = 'selection-grid';
            grid.style.gridTemplateColumns = `auto repeat(${maxResponses}, 1fr)`;

            grid.appendChild(document.createElement('div')); 
            for (let i = 0; i < maxResponses; i++) {
                const headerCell = document.createElement('div');
                headerCell.className = 'grid-cell grid-header';
                headerCell.textContent = `Res ${i + 1}`;
                grid.appendChild(headerCell);
            }

            allTrajectories.forEach((traj, rowIndex) => {
                const rowHeader = document.createElement('div');
                rowHeader.className = 'grid-cell grid-row-header';
                rowHeader.textContent = `ID: ${traj.id || rowIndex}`;
                grid.appendChild(rowHeader);

                for (let colIndex = 0; colIndex < maxResponses; colIndex++) {
                    const cell = document.createElement('div');
                    cell.dataset.row = rowIndex;
                    cell.dataset.col = colIndex;
                    if (colIndex < (traj.responses?.length || 0)) {
                        cell.className = 'grid-cell selectable';
                        cell.title = `Question ${traj.id || rowIndex}, Response ${colIndex + 1}`;
                    } else {
                        cell.className = 'grid-cell';
                    }
                    grid.appendChild(cell);
                }
            });

            container.innerHTML = '';
            container.appendChild(grid);

            grid.addEventListener('mousedown', handleGridMouseDown);
            grid.addEventListener('mousemove', handleGridMouseMove);
            document.addEventListener('mouseup', handleGridMouseUp);
        }

        function handleGridMouseDown(e) {
            const cell = e.target.closest('.selectable');
            if (!cell) return;
            e.preventDefault();
            
            isDragging = true;
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            dragStartCell = { row, col };

            const key = `${row}-${col}`;
            if (e.ctrlKey || e.metaKey) {
                if (selectionState.has(key)) {
                    selectionState.delete(key);
                    cell.classList.remove('selected');
                } else {
                    selectionState.add(key);
                    cell.classList.add('selected');
                }
            } else {
                 if (!selectionState.has(key)) {
                    document.querySelectorAll('#selection-grid .selectable.selected').forEach(c => c.classList.remove('selected'));
                    selectionState.clear();
                }
                selectionState.add(key);
                cell.classList.add('selected');
            }
        }

        function handleGridMouseMove(e) {
            if (!isDragging) return;
            const cell = e.target.closest('.selectable');
            if (!cell) return;

            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            
            const minRow = Math.min(dragStartCell.row, row);
            const maxRow = Math.max(dragStartCell.row, row);
            const minCol = Math.min(dragStartCell.col, col);
            const maxCol = Math.max(dragStartCell.col, col);

            document.querySelectorAll('#selection-grid .selectable.selected').forEach(c => c.classList.remove('selected'));
            
            for (let r = 0; r < allTrajectories.length; r++) {
                for (let c = 0; c < (allTrajectories[r].responses?.length || 0); c++) {
                    const currentCell = document.querySelector(`.selectable[data-row='${r}'][data-col='${c}']`);
                    if (currentCell) {
                        const key = `${r}-${c}`;
                         if (r >= minRow && r <= maxRow && c >= minCol && c <= maxCol) {
                            currentCell.classList.add('selected');
                        } else if (selectionState.has(key)) {
                            currentCell.classList.add('selected');
                        }
                    }
                }
            }
        }

        function handleGridMouseUp(e) {
            if (!isDragging) return;
            isDragging = false;
            
            const cell = e.target.closest('.selectable');
            if (!cell) return;

            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);

            const minRow = Math.min(dragStartCell.row, row);
            const maxRow = Math.max(dragStartCell.row, row);
            const minCol = Math.min(dragStartCell.col, col);
            const maxCol = Math.max(dragStartCell.col, col);

            for (let r = minRow; r <= maxRow; r++) {
                for (let c = minCol; c <= maxCol; c++) {
                     const currentCell = document.querySelector(`.selectable[data-row='${r}'][data-col='${c}']`);
                     if (currentCell) {
                         selectionState.add(`${r}-${c}`);
                     }
                }
            }
        }

        function clearSelection() {
            selectionState.clear();
            document.querySelectorAll('#selection-grid .selectable.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
        }

        const createChart = (canvasId, chartConfig) => {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(ctx, chartConfig);
        };
        
        const chartDataLabelConfig = {
            anchor: 'end',
            align: 'top',
            formatter: (value) => Math.round(value * 100) / 100, // Round to 2 decimal places
            font: {
                weight: 'normal',
                family: 'Inter, sans-serif'
            },
            color: '#4b5563' // gray-600
        };

        function renderGlobalStats() {
            const { displayName } = getToolConfig();
            document.getElementById('secondary-tool-dist-title').textContent = `${displayName} Usage Distribution`;

            const questionLabels = allTrajectories.map((t, i) => t.id || `Index ${i}`);
            const questionRates = allTrajectories.map(traj => {
                const scores = traj.score_lst || [];
                return scores.length > 0 ? scores.filter(s => s === 1.0).length / scores.length : 0;
            });
            createChart('per-question-correctness-chart', {
                type: 'bar',
                data: { labels: questionLabels, datasets: [{ label: 'Correctness Rate', data: questionRates, backgroundColor: 'rgba(22, 163, 74, 0.5)', borderColor: 'rgba(22, 163, 74, 1)' }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true, max: 1, title: { display: true, text: 'Correctness Rate' } }, x: { title: { display: true, text: 'Question ID' } } }, 
                    plugins: { legend: { display: false }, datalabels: chartDataLabelConfig },
                    onClick: (e) => {
                        const chart = chartInstances['per-question-correctness-chart'];
                        const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const index = firstPoint.index;
                            trajectorySelect.value = index;
                            trajectorySelect.dispatchEvent(new Event('change'));
                            document.getElementById('trajectory-detail').scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                }
            });

            const binData = Array(10).fill(0).map(() => ({ count: 0, ids: [] }));
            const binLabels = Array.from({length: 10}, (_, i) => `${i*10+1}-${(i+1)*10}%`);
            binLabels[0] = "0-10%";
            allTrajectories.forEach((traj, index) => {
                const rate = questionRates[index];
                const binIndex = rate === 1 ? 9 : Math.min(Math.floor(rate * 10), 9);
                binData[binIndex].count++;
                binData[binIndex].ids.push(traj.id || `Index ${index}`);
            });
            createChart('correctness-rate-chart', {
                type: 'bar',
                data: { labels: binLabels, datasets: [{ label: 'Number of Questions', data: binData.map(b => b.count), backgroundColor: 'rgba(79, 70, 229, 0.5)', borderColor: 'rgba(79, 70, 229, 1)' }] },
                options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Questions' } }, x: { title: { display: true, text: 'Correctness Rate Bins' } } }, plugins: { legend: { display: false }, datalabels: chartDataLabelConfig, tooltip: { callbacks: {
                    afterBody: (context) => {
                        const binIndex = context[0].dataIndex;
                        const ids = binData[binIndex].ids;
                        if (!ids || ids.length === 0) return '';
                        const idChunks = [];
                        for (let i = 0; i < ids.length; i += 5) {
                            idChunks.push(ids.slice(i, i + 5).join(', '));
                        }
                        return ['\nQuestion IDs:', ...idChunks];
                    }
                }}}}
            });

            const toolUsage = { correct: { python: [], secondary: [] }, incorrect: { python: [], secondary: [] } };
            allTrajectories.forEach(traj => {
                (traj.responses || []).forEach((resp, i) => {
                    const score = traj.score_lst?.[i];
                    const counts = traj.tool_counts?.[i];
                    if (score === 1.0) {
                        toolUsage.correct.python.push(counts.python);
                        toolUsage.correct.secondary.push(counts.secondary);
                    } else if (score === 0.0) {
                        toolUsage.incorrect.python.push(counts.python);
                        toolUsage.incorrect.secondary.push(counts.secondary);
                    }
                });
            });
            const calcAvg = arr => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
            createChart('avg-tool-usage-chart', {
                type: 'bar',
                data: {
                    labels: ['Python Executor', displayName],
                    datasets: [
                        { label: 'Correct Responses', data: [calcAvg(toolUsage.correct.python), calcAvg(toolUsage.correct.secondary)], backgroundColor: 'rgba(34, 197, 94, 0.6)' },
                        { label: 'Incorrect Responses', data: [calcAvg(toolUsage.incorrect.python), calcAvg(toolUsage.incorrect.secondary)], backgroundColor: 'rgba(239, 68, 68, 0.6)' }
                    ]
                },
                options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Average Number of Calls' } } }, plugins: { legend: { position: 'top' }, datalabels: chartDataLabelConfig } }
            });

            const createDistChart = (canvasId, counts) => {
                const freqMap = counts.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                const labels = Object.keys(freqMap).sort((a,b) => a-b);
                const data = labels.map(key => freqMap[key]);
                createChart(canvasId, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Number of Responses', data, backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgba(59, 130, 246, 1)' }] },
                    options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Responses' } }, x: { title: { display: true, text: 'Number of Tool Calls' } } }, plugins: { legend: { display: false }, datalabels: chartDataLabelConfig } }
                });
            };
            createDistChart('global-python-chart', allTrajectories.flatMap(t => t.tool_counts.map(c => c.python)));
            createDistChart('global-secondary-tool-chart', allTrajectories.flatMap(t => t.tool_counts.map(c => c.secondary)));
        }

        function renderPerQuestionToolUsageHistograms(traj) {
            if (!traj || !traj.tool_counts) return;
            const { displayName } = getToolConfig();
            document.getElementById('per-question-secondary-tool-title').textContent = displayName;

            const createPerQuestionChart = (canvasId, counts) => {
                const freqMap = counts.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                const labels = Object.keys(freqMap).sort((a,b) => a-b);
                const data = labels.map(key => freqMap[key]);
                createChart(canvasId, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Number of Responses', data, backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgba(59, 130, 246, 1)' }] },
                    options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Responses' } }, x: { title: { display: true, text: 'Number of Tool Calls' } } }, plugins: { legend: { display: false }, datalabels: chartDataLabelConfig } }
                });
            };
            createPerQuestionChart('per-question-python-chart', traj.tool_counts.map(c => c.python));
            createPerQuestionChart('per-question-secondary-tool-chart', traj.tool_counts.map(c => c.secondary));
        }

        function exportSelections() {
            if (selectionState.size === 0) {
                alert('Please select at least one response to export.');
                return;
            }

            const selectionsByTraj = {};
            selectionState.forEach(key => {
                const [trajIndex, respIndex] = key.split('-').map(Number);
                if (!selectionsByTraj[trajIndex]) selectionsByTraj[trajIndex] = [];
                selectionsByTraj[trajIndex].push(respIndex);
            });

            let jsonlString = '';
            for (const trajIndex in selectionsByTraj) {
                const originalTraj = allTrajectories[trajIndex];
                const selectedRespIndices = selectionsByTraj[trajIndex].sort((a, b) => a - b);
                
                const newTraj = JSON.parse(JSON.stringify(originalTraj));
                newTraj.responses = selectedRespIndices.map(i => originalTraj.responses[i]);
                newTraj.score_lst = selectedRespIndices.map(i => originalTraj.score_lst[i]);
                
                delete newTraj.tool_counts; 
                jsonlString += JSON.stringify(newTraj) + '\n';
            }

            const blob = new Blob([jsonlString.trim()], { type: 'application/jsonl;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'selected_responses.jsonl';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function saveApiConfig() {
            const baseUrlInput = document.getElementById('custom-base-url');
            if (baseUrlInput) {
                customApiModelConfig.baseUrl = baseUrlInput.value;
                customApiModelConfig.apiKey = document.getElementById('custom-api-key').value;
                customApiModelConfig.modelName = document.getElementById('custom-model-name').value;
            }
        }
        
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function displayTrajectoryDetail(index) {
            if (index < 0) return;
            saveApiConfig();
            const traj = allTrajectories[index];
            const { displayName } = getToolConfig();
            
            let html = `<h2 class="text-2xl font-bold text-gray-900 border-b border-gray-200 pb-3 mb-6">Trajectory ID: ${traj.id}</h2>`;
            html += `<div class="mb-6"><h3 class="font-semibold text-lg text-gray-800 mb-2">Question:</h3><div class="p-4 bg-gray-50 rounded-lg prose">${renderContent(traj.extra_info.question)}</div></div>`;
            html += renderExtraInfo(traj.extra_info);

            html += `<div class="space-y-3 mb-6">`;
            traj.prompt.forEach(p => {
                if (p.role === 'system') html += createMessageHTML('System', 'bg-gray-100', 'text-gray-600', `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 2v2"/><path d="M9 2v2"/></svg>`, p.content);
                else if (p.role === 'user') html += createMessageHTML('User', 'bg-green-50', 'text-green-800', `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`, p.content);
            });
            html += `</div>`;

            html += `
                <div id="per-question-stats-section" class="border-t border-gray-200 pt-6 mt-8">
                    <h3 class="font-semibold text-lg text-gray-800 mb-4">Tool Usage Statistics (Current Question)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2 text-center">Python Executor</h4>
                            <canvas id="per-question-python-chart"></canvas>
                        </div>
                        <div>
                            <h4 id="per-question-secondary-tool-title" class="font-medium text-gray-700 mb-2 text-center">${displayName}</h4>
                            <canvas id="per-question-secondary-tool-chart"></canvas>
                        </div>
                    </div>
                </div>`;

            html += `
                <div id="response-filter-section" class="border-t border-gray-200 pt-6 mt-8">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <h3 class="font-semibold text-lg text-gray-800">Model Response Filter</h3>
                        <label for="raw-toggle" class="flex items-center cursor-pointer">
                            <span class="mr-2 text-sm text-gray-600">Show Raw Format</span>
                            <div class="relative">
                                <input type="checkbox" id="raw-toggle" class="sr-only peer">
                                <div class="toggle-bg block bg-gray-200 w-10 h-6 rounded-full peer-checked:bg-indigo-600"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform peer-checked:translate-x-full"></div>
                            </div>
                        </label>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div id="score-filter-container" class="flex flex-col space-y-2">
                            <span class="text-sm font-medium text-gray-700">Filter by score:</span>
                            <div class="flex items-center"><input type="radio" id="filter-all" name="score-filter" value="all" onchange="updateTrajectoryView()" checked><label for="filter-all" class="ml-2 text-sm">All</label></div>
                            <div class="flex items-center"><input type="radio" id="filter-correct" name="score-filter" value="1.0" onchange="updateTrajectoryView()"><label for="filter-correct" class="ml-2 text-sm text-green-600">Correct (1.0)</label></div>
                            <div class="flex items-center"><input type="radio" id="filter-incorrect" name="score-filter" value="0.0" onchange="updateTrajectoryView()"><label for="filter-incorrect" class="ml-2 text-sm text-red-600">Incorrect (0.0)</label></div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <span class="text-sm font-medium text-gray-700">Filter by Python calls:</span>
                            <div class="flex items-center gap-2">
                                <select id="python-op" onchange="updateTrajectoryView()" class="p-1 border border-gray-300 rounded-md text-sm"><option value=">=" selected>≥</option><option value="=">=</option><option value="<=">≤</option><option value=">">&gt;</option><option value="<">&lt;</option></select>
                                <input type="number" id="python-val" onchange="updateTrajectoryView()" value="0" min="0" class="w-20 p-1 border border-gray-300 rounded-md text-sm">
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <span id="secondary-tool-filter-label" class="text-sm font-medium text-gray-700">Filter by ${displayName} calls:</span>
                             <div class="flex items-center gap-2">
                                <select id="secondary-tool-op" onchange="updateTrajectoryView()" class="p-1 border border-gray-300 rounded-md text-sm"><option value=">=" selected>≥</option><option value="=">=</option><option value="<=">≤</option><option value=">">&gt;</option><option value="<">&lt;</option></select>
                                <input type="number" id="secondary-tool-val" onchange="updateTrajectoryView()" value="0" min="0" class="w-20 p-1 border border-gray-300 rounded-md text-sm">
                            </div>
                        </div>
                    </div>
                </div>`;
            
            html += `<div id="tabs-and-response-container" class="mt-6"></div>`;
            trajectoryDetailContainer.innerHTML = html;
            
            document.getElementById('raw-toggle').addEventListener('change', handleRawToggle);

            renderPerQuestionToolUsageHistograms(traj);
            renderTabsAndResponse(index);
        }
        
        function checkCondition(val1, op, val2) {
            switch(op) {
                case '>=': return val1 >= val2;
                case '<=': return val1 <= val2;
                case '>': return val1 > val2;
                case '<': return val1 < val2;
                case '=': return val1 == val2;
                default: return true;
            }
        }

        function renderTabsAndResponse(index) {
            const container = document.getElementById('tabs-and-response-container');
            if (!container) return;

            const traj = allTrajectories[index];
            const scoreFilter = document.querySelector('input[name="score-filter"]:checked')?.value || 'all';
            const pythonOp = document.getElementById('python-op').value;
            const pythonVal = parseInt(document.getElementById('python-val').value, 10);
            const secondaryToolOp = document.getElementById('secondary-tool-op').value;
            const secondaryToolVal = parseInt(document.getElementById('secondary-tool-val').value, 10);
            
            const { label: secondaryToolLabel } = getToolConfig();
            
            const responses = traj.responses || [];
            const scores = traj.score_lst || [];
            const toolCounts = traj.tool_counts || [];
            
            let visibleResponses = [];
            responses.forEach((resp, i) => {
                const score = scores[i];
                const counts = toolCounts[i] || { python: 0, secondary: 0 };
                
                const scoreMatch = scoreFilter === 'all' || (score !== undefined && score.toFixed(1) === scoreFilter);
                const pythonMatch = checkCondition(counts.python, pythonOp, pythonVal);
                const secondaryToolMatch = checkCondition(counts.secondary, secondaryToolOp, secondaryToolVal);

                if (scoreMatch && pythonMatch && secondaryToolMatch) {
                    visibleResponses.push({ index: i, score: score, counts: counts });
                }
            });

            let tabsHtml = '';
            if (visibleResponses.length > 0) {
                 tabsHtml += `<div class="relative mb-4"><div class="overflow-x-auto pb-2"><div class="flex border-b border-gray-200 whitespace-nowrap" id="response-tabs">`;
                visibleResponses.forEach((respInfo, tabIndex) => {
                    const score = respInfo.score;
                    let tabColorClass = 'text-gray-500 hover:text-gray-700';
                    if (score === 1.0) tabColorClass = 'text-green-700 hover:text-green-800';
                    else if (score === 0.0) tabColorClass = 'text-red-700 hover:text-red-800';
                    
                    let activeClass = tabIndex === 0 ? ' border-b-2 ' : '';
                    if (tabIndex === 0) {
                        if (score === 1.0) activeClass += 'border-green-600 text-green-600';
                        else if (score === 0.0) activeClass += 'border-red-600 text-red-600';
                        else activeClass += 'border-blue-600 text-blue-600';
                    }
                    
                    const toolCountText = `[Py:${respInfo.counts.python}, ${secondaryToolLabel}:${respInfo.counts.secondary}]`;
                    tabsHtml += `<button onclick="switchResponseTab(this, ${index}, ${respInfo.index})" class="response-tab flex flex-col items-center py-2 px-4 text-sm font-medium text-center shrink-0 ${tabColorClass} ${activeClass}">
                                    <span>Res ${respInfo.index + 1} (${score !== undefined ? score : 'N/A'})</span>
                                    <span class="text-xs mt-1 font-mono">${toolCountText}</span>
                                 </button>`;
                });
                tabsHtml += `</div></div></div>`;
            }
            
            const firstVisibleIndex = visibleResponses.length > 0 ? visibleResponses[0].index : -1;
            container.innerHTML = tabsHtml + `<div id="response-content-area" data-current-traj-index="${index}" data-current-resp-index="${firstVisibleIndex}"></div>`;

            if (firstVisibleIndex !== -1) {
                displayResponse(index, firstVisibleIndex);
            } else {
                document.getElementById('response-content-area').innerHTML = `<div class="text-center text-gray-500 p-8">No responses match the current filter criteria.</div>`;
            }

            setTimeout(() => {
                if (window.renderMathInElement) {
                    renderMathInElement(trajectoryDetailContainer, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                }
            }, 0);
        }
        
        function updateTrajectoryView() {
            saveApiConfig();
            const selectedIndex = trajectorySelect.value;
            if (selectedIndex >= 0) {
                renderTabsAndResponse(selectedIndex);
            }
        }
        
        function switchResponseTab(button, trajIndex, respIndex) {
            saveApiConfig();
            document.querySelectorAll('#response-tabs .response-tab').forEach(btn => {
                btn.classList.remove('text-green-600', 'text-red-600', 'text-blue-600', 'border-b-2', 'border-green-600', 'border-red-600', 'border-blue-600');
                btn.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            
            const score = allTrajectories[trajIndex].score_lst[respIndex];
            button.classList.add('border-b-2');
             if (score === 1.0) button.classList.add('border-green-600', 'text-green-600');
             else if (score === 0.0) button.classList.add('border-red-600', 'text-red-600');
             else button.classList.add('border-blue-600', 'text-blue-600');
            
            const responseArea = document.getElementById('response-content-area');
            responseArea.dataset.currentRespIndex = respIndex;
            displayResponse(trajIndex, respIndex);
        }

        async function generateAISummary(button, trajIndex, respIndex) {
            saveApiConfig();
            const scoreContainer = document.getElementById(`ai-summary-score-${respIndex}`);
            const contentContainer = document.getElementById(`ai-summary-content-${respIndex}`);
            
            if (!scoreContainer || !contentContainer) return;

            button.disabled = true;
            contentContainer.innerHTML = '<p class="text-gray-500 animate-pulse">Generating summary...</p>';
            contentContainer.classList.remove('hidden');
            scoreContainer.innerHTML = '';

            const traj = allTrajectories[trajIndex];
            const responseText = traj.responses[respIndex];
            const solution = traj.extra_info.solution;
            const score = traj.score_lst[respIndex];
            const isSuccess = score === 1.0;

            let prompt;
            if (isSuccess) {
                prompt = `Please analyze the following successful problem-solving attempt and focus on evaluating the quality of tool calls.\n- Reference correct answer:\n\`\`\`\n${solution}\n\`\`\`\n- Model's attempt:\n\`\`\`\n${responseText}\n\`\`\`\nPlease strictly follow this output structure:\n\n1. Summary (Conclusion first)\n   - Summarize in 2-3 sentences whether this solution is robust and reusable.\n\n2. Problem-Solving Approach (Brief)\n   - Rephrase the core idea and key intermediate conclusions in your own words.\n\n3. Tool Usage Evaluation\n   - Selection & Rationale: List key calls, marking them as "Critical/Auxiliary/Redundant". Explain why each was needed or not.\n   - Timing: Were calls made at the right moment? Any irrelevant or duplicate calls?\n   - Return Content Quality: Was the return correct, complete, and reliable? Did the model interpret and adopt it correctly? Point out if key info was ignored.\n   - Coherence & Dependency Passing: Was there a closed loop between multiple tools?\n   - Helpfulness Quantification: Identify which calls directly led to key inferences or calculations, specifying "[Step X] Tool Name: Impact (High/Medium/Low)".\n   - Error Handling: Were exceptions/failures recognized and handled? Any defensive checks or secondary validations?\n   - Evidence Requirement: Cite evidence using "[Step X] Tool Name: Key Info Summary"; quote no more than two lines if necessary.\n\n4. Risks & Improvements\n   - Potential edge case risks, data/return instability risks.\n   - Actionable improvement suggestions: alternative tools, reducing calls, parallelization/caching, adding validation or self-consistency checks, etc.\n\nFinally, based on the analysis above, provide a comprehensive quality score in the format "Rating: X/10".`;
            } else {
                prompt = `Please analyze the following failed problem-solving attempt, focusing on identifying the cause of failure and evaluating tool call quality and fixability.\n- Reference correct answer:\n\`\`\`\n${solution}\n\`\`\`\n- Model's attempt:\n\`\`\`\n${responseText}\n\`\`\`\nPlease strictly follow this output structure:\n\n1. Summary (Conclusion first)\n   - Summarize in 2-3 sentences the main reason for failure and whether it's quickly fixable.\n\n2. Failure Cause Identification (including tool factors)\n   - Pinpoint where the deviation occurred (concept/formula/calculation/edge case/implementation/tool return interpretation) and provide a minimal counterexample or evidence.\n   - If caused by tools (misuse, misread return, incoherence, missed necessary calls, etc.), specify each point as "[Step X] Tool Name: Issue and Impact".\n\n3. Approach Evaluation\n   - Was the initial direction correct? At which step did it deviate? Were there early signals that could have been intercepted?\n\n4. Tool Usage Evaluation\n   - Selection & Rationale: List key calls, marking them as "Critical/Auxiliary/Redundant". Explain why each was needed or not.\n   - Timing: Were calls made at the right moment? Any irrelevant or duplicate calls?\n   - Return Content Quality: Was the return correct, complete, and reliable? Did the model interpret and adopt it correctly? Point out if key info was ignored.\n   - Coherence & Dependency Passing: Was there a closed loop between multiple tools?\n   - Helpfulness Quantification: Identify which calls directly led to key inferences or calculations, specifying "[Step X] Tool Name: Impact (High/Medium/Low)".\n   - Error Handling: Were exceptions/failures recognized and handled? Any defensive checks or secondary validations?\n   - Evidence Requirement: Cite evidence using "[Step X] Tool Name: Key Info Summary"; quote no more than two lines if necessary.\n\n5. Differences from Correct Answer\n   - Compare key steps/intermediate values/validation processes; point out tools and sequences that should have been used or adjusted.\n\nFinally, based on the analysis above, provide a comprehensive quality score in the format "Rating: X/10".`;
            }

            const customBaseUrl = customApiModelConfig.baseUrl;
            const customApiKey = customApiModelConfig.apiKey;
            const customModelName = customApiModelConfig.modelName;

            let apiUrl, payload, headers = { 'Content-Type': 'application/json' };

            if (customBaseUrl && customApiKey && customModelName) {
                apiUrl = customBaseUrl.endsWith('/chat/completions') ? customBaseUrl : `${customBaseUrl.replace(/\/+$/, '')}/chat/completions`;
                headers['Authorization'] = `Bearer ${customApiKey}`;
                payload = { model: customModelName, messages: [{ role: "user", content: prompt }] };
            } else {
                const geminiApiKey = ""; // Injected by environment
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
                payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            }
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                }
                const result = await response.json();
                
                let summaryText = "Could not retrieve analysis result.";
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    summaryText = result.candidates[0].content.parts[0].text; // Gemini
                } else if (result.choices?.[0]?.message?.content) {
                    summaryText = result.choices[0].message.content; // OpenAI
                }
                
                const scoreMatch = summaryText.match(/Rating:\s*(\d+(\.\d+)?\s*\/\s*10)/i);
                if (scoreMatch) {
                    scoreContainer.innerHTML = `<span class="text-lg font-bold text-blue-600">${scoreMatch[1]}</span>`;
                }
                contentContainer.innerHTML = marked.parse(summaryText);
            } catch (error) {
                console.error("AI Summary Error:", error);
                contentContainer.innerHTML = `<p class="text-red-500">Failed to generate summary: ${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }

        function displayResponse(trajIndex, respIndex) {
            if (trajIndex < 0 || respIndex < 0) return;
            const responseArea = document.getElementById('response-content-area');
            if (!responseArea) return;
            
            const traj = allTrajectories[trajIndex];
            const resp = traj.responses[respIndex];
            const isRawView = document.getElementById('raw-toggle')?.checked || false;
            
            let responseContent = isRawView 
                ? `<pre class="text-sm bg-gray-100 text-gray-800 p-3 rounded-md overflow-x-auto"><code>${escapeHTML(resp || '')}</code></pre>`
                : parseAndRenderResponse(resp);
            
            const collapseControls = `
                <div class="flex items-center gap-2 mb-4">
                    <button onclick="expandAllDetails('response-content-area')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-full">Expand All</button>
                    <button onclick="collapseAllDetails('response-content-area')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-full">Collapse All</button>
                </div>
            `;

            const aiSummaryHtml = `
                <div id="ai-summary-section" class="mt-6 border-t pt-6">
                    <div class="flex justify-between items-center mb-4">
                         <h4 class="text-lg font-semibold text-gray-800">AI Summary & Scoring</h4>
                         <button onclick="generateAISummary(this, ${trajIndex}, ${respIndex})" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors shadow-sm disabled:bg-gray-400">
                            Generate Summary
                        </button>
                    </div>
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg mb-4">
                        <h5 class="font-medium text-sm text-gray-600 mb-3">Custom Model (OpenAI Compatible)</h5>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="custom-base-url" class="block text-xs font-medium text-gray-500">Base URL</label>
                                <input type="text" id="custom-base-url" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., https://api.openai.com" value="${escapeHTML(customApiModelConfig.baseUrl)}">
                            </div>
                             <div>
                                <label for="custom-api-key" class="block text-xs font-medium text-gray-500">API Key</label>
                                <input type="password" id="custom-api-key" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="sk-..." value="${escapeHTML(customApiModelConfig.apiKey)}">
                            </div>
                            <div>
                                <label for="custom-model-name" class="block text-xs font-medium text-gray-500">Model Name</label>
                                <input type="text" id="custom-model-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., gpt-4-turbo" value="${escapeHTML(customApiModelConfig.modelName)}">
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">If left blank, the default Gemini model will be used.</p>
                    </div>
                    <div id="ai-summary-score-${respIndex}" class="text-center text-2xl font-bold mt-4 text-purple-700"></div>
                    <div id="ai-summary-content-${respIndex}" class="ai-summary-content mt-2 p-4 bg-purple-50 rounded-lg border border-purple-200 hidden prose"></div>
                </div>
            `;

            responseArea.innerHTML = createMessageHTML('Assistant', 'bg-indigo-50', 'text-indigo-800', `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 14 4-4"/><path d="M12 14 8 10"/><path d="M12 20v-8"/><path d="M20 12h-4.34a1 1 0 0 0-1 1.66l.9 1.68a1 1 0 0 1-1.52 1.32l-1.68-.9a1 1 0 0 0-1.66 0l-1.68.9a1 1 0 0 1-1.52-1.32l.9-1.68A1 1 0 0 0 8.34 12H4"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M12 2v2"/></svg>`, collapseControls + responseContent, true) + aiSummaryHtml;

            if (!isRawView && window.renderMathInElement) {
                 setTimeout(() => {
                    renderMathInElement(responseArea, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                }, 0);
            }
        }

        function renderExtraInfo(extraInfo) {
            if (!extraInfo) return '';
            let dlHtml = '<dl class="space-y-4">';
            for (const key in extraInfo) {
                if (key === 'question') continue;
                const value = extraInfo[key];
                let valueHtml = '';
                if (value === null || value === undefined) {
                    valueHtml = `<span class="text-gray-500">N/A</span>`;
                } else if (key === 'solution') {
                    valueHtml = `<div class="p-3 bg-gray-50 rounded-md prose">${renderContent(value)}</div>`;
                } else if (typeof value === 'object') {
                    valueHtml = `<pre class="text-sm bg-gray-100 text-gray-800 p-3 rounded-md overflow-x-auto"><code>${JSON.stringify(value, null, 2)}</code></pre>`;
                } else {
                    valueHtml = `<span class="text-gray-800 break-all">${value}</span>`;
                }
                dlHtml += `<div class="grid grid-cols-1 sm:grid-cols-4 gap-x-4"><dt class="text-sm font-medium text-gray-500 capitalize">${key.replace(/_/g, ' ')}:</dt><dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-3">${valueHtml}</dd></div>`;
            }
            dlHtml += '</dl>';

            return `
                <div class="mb-6 border-t pt-6 mt-6">
                    <details class="bg-gray-50 border-gray-200">
                        <summary class="text-lg font-semibold text-gray-800">
                            ${collapsibleIconSvg}
                            Metadata
                        </summary>
                        <div class="collapsible-content">
                            ${dlHtml}
                        </div>
                    </details>
                </div>`;
        }
        
        function handleRawToggle() {
            saveApiConfig();
            const responseArea = document.getElementById('response-content-area');
            if (responseArea) {
                const trajIndex = responseArea.dataset.currentTrajIndex;
                const respIndex = responseArea.dataset.currentRespIndex;
                displayResponse(trajIndex, respIndex);
            }
        }

        function createMessageHTML(role, bgColor, textColor, iconSvg, content, isHtml = false) {
            const renderedContent = isHtml ? content : renderContent(content);
            return `<div class="flex items-start gap-3"><div class="p-2 mt-1 rounded-full ${bgColor}">${iconSvg.replace('currentColor', textColor)}</div><div class="flex-1"><p class="font-bold ${textColor}">${role}</p><div class="prose">${renderedContent}</div></div></div>`;
        }
        
        const collapsibleIconSvg = `<svg class="collapsible-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
        const errorIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`;

        function parseAndRenderResponse(responseString) {
            if (!responseString) return '';
            const regex = /(<think>[\s\S]*?<\/think>|<tool_call>[\s\S]*?<\/tool_call>|<tool_response>[\s\S]*?<\/tool_response>)/g;
            let lastIndex = 0;
            let html = '';
            let match;

            while ((match = regex.exec(responseString)) !== null) {
                const precedingText = responseString.substring(lastIndex, match.index).trim();
                if (precedingText && precedingText.toLowerCase() !== 'user' && precedingText.toLowerCase() !== 'assistant') {
                    html += `<div class="prose">${renderContent(precedingText)}</div>`;
                }

                const trimmedPart = match[0].trim();
                if (trimmedPart.startsWith('<think>')) {
                    const content = trimmedPart.replace(/^<think>|<\/think>$/g, '').trim();
                    const innerHtml = parseAndRenderResponse(content);
                    html += `<details class="bg-yellow-50 border-yellow-200"><summary class="text-yellow-800">${collapsibleIconSvg}🤔 Thought</summary><div class="collapsible-content text-sm text-gray-700">${innerHtml}</div></details>`;
                } else if (trimmedPart.startsWith('<tool_call>')) {
                    const content = trimmedPart.replace(/^<tool_call>|<\/tool_call>$/g, '').trim();
                    try {
                        const jsonContent = JSON.parse(content);
                        const toolName = (jsonContent.name || 'Unknown Tool').trim();
                        const args = jsonContent.arguments;
                        let argsHtml = '';
                        
                        // FIX: Handle both string and object formats for python_code_executor arguments
                        if (toolName === 'python_code_executor') {
                            let pythonCode = '';
                            if (typeof args === 'string') {
                                // New case: arguments is a string, potentially with markdown fences
                                pythonCode = args.replace(/^```[a-z]*\n|```$/g, '').trim();
                            } else if (args && typeof args.code === 'string') {
                                // Original case: arguments is an object with a 'code' property
                                pythonCode = args.code;
                            }
                            if(pythonCode) {
                                argsHtml = `<pre class="text-sm bg-gray-900 text-white p-3 rounded-md overflow-x-auto"><code>${escapeHTML(pythonCode)}</code></pre>`;
                            } else {
                                // Fallback for unexpected format
                                argsHtml = `<pre class="text-sm bg-gray-100 text-gray-800 p-3 rounded-md overflow-x-auto"><code>${JSON.stringify(args, null, 2)}</code></pre>`;
                            }
                        } else if (toolName === 'rag_system_retrieve' && args.repo_name && args.query) {
                            const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 shrink-0"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`;
                            argsHtml = `<div class="text-sm flex flex-col gap-2">
                                <div class="flex items-center gap-2">${svgIcon}<span class="font-semibold">Repo:</span><span class="font-mono bg-gray-200 px-2 py-0.5 rounded">${escapeHTML(args.repo_name)}</span></div>
                                <div><span class="font-semibold">Query:</span><div class="mt-1 p-2 bg-gray-100 rounded">${escapeHTML(args.query)}</div></div>
                            </div>`;
                        } else if (toolName === 'chat_with_repository' && args.repo_url) { // Legacy support
                             const repoUrl = (args.repo_url || '').trim();
                             let messagesHtml = (args.messages || []).map(msg => `<div class="flex items-start gap-2 text-sm my-1"><span class="font-semibold capitalize text-gray-500">${(msg.role || '').trim()}:</span><span class="text-gray-700">${(msg.content || '').trim()}</span></div>`).join('');
                             const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 shrink-0"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>`;
                             argsHtml = `<div class="text-sm"><div class="flex items-center gap-2">${svgIcon}<a href="${repoUrl}" target="_blank" class="text-blue-600 hover:underline break-all">${repoUrl}</a></div><div class="mt-2 pt-2 border-t border-gray-200">${messagesHtml}</div></div>`;
                        } else {
                             argsHtml = `<pre class="text-sm bg-gray-100 text-gray-800 p-3 rounded-md overflow-x-auto"><code>${JSON.stringify(args, null, 2)}</code></pre>`;
                        }
                        
                        const displayName = (secondaryToolConfig[toolName] || {displayName: toolName}).displayName;
                        const toolNameHtml = `<span class="font-mono bg-blue-100 text-blue-900 px-2 py-0.5 rounded">${displayName}</span>`;
                        html += `<details open class="bg-blue-50 border-blue-200"><summary class="text-blue-800">${collapsibleIconSvg}🛠️ Tool Call: ${toolNameHtml}</summary><div class="collapsible-content">${argsHtml}</div></details>`;
                    } catch (e) {
                         html += `<details open class="bg-red-50 border-red-200"><summary class="font-bold text-sm text-red-800">${collapsibleIconSvg}Invalid Tool Call JSON</summary><div class="collapsible-content"><pre class="mt-2 text-sm">${content}</pre></div></details>`;
                    }
                } else if (trimmedPart.startsWith('<tool_response>')) {
                     const content = trimmedPart.replace(/^<tool_response>|<\/tool_response>$/g, '').trim();
                     const errorKeywords = ['traceback', 'error', 'failed', 'unsupported', '!!!', 'exception', 'not defined'];
                     const isError = errorKeywords.some(keyword => content.toLowerCase().includes(keyword));
                     
                     if (isError) {
                         html += `<details open class="bg-red-50 border-red-200"><summary class="text-red-800">${errorIconSvg}⚙️ Tool Response (Error)</summary><div class="collapsible-content text-sm text-gray-700 prose">${renderContent(content)}</div></details>`;
                     } else {
                         html += `<details open class="bg-purple-50 border-purple-200"><summary class="text-purple-800">${collapsibleIconSvg}⚙️ Tool Response</summary><div class="collapsible-content text-sm text-gray-700 prose">${renderContent(content)}</div></details>`;
                     }
                }
                lastIndex = regex.lastIndex;
            }

            const remainingText = responseString.substring(lastIndex).trim();
            if (remainingText && remainingText.toLowerCase() !== 'user' && remainingText.toLowerCase() !== 'assistant') {
                html += `<div class="prose">${renderContent(remainingText)}</div>`;
            }
            return html;
        }

        function renderContent(text) {
            if (!text) return '';
            const mathPlaceholders = [];
            let processedText = text;
            const mathPatterns = [ /\$\$[\s\S]*?\$\$/g, /\$[^$\n]*?\$/g, /\\\[[\s\S]*?\\\]/g, /\\\([\s\S]*?\\\)/g ];
            
            mathPatterns.forEach(pattern => {
                processedText = processedText.replace(pattern, (match) => {
                    const placeholder = `MATHPLACEHOLDER${mathPlaceholders.length}MATHPLACEHOLDER`;
                    mathPlaceholders.push(match);
                    return placeholder;
                });
            });
            processedText = processedText.replace(/\\boxed\{([^}]+)\}/g, (match, content) => {
                const placeholder = `MATHPLACEHOLDER${mathPlaceholders.length}MATHPLACEHOLDER`;
                mathPlaceholders.push(`$\\boxed{${content}}$`);
                return placeholder;
            });
            let htmlContent = marked.parse(processedText, { breaks: true });
            mathPlaceholders.forEach((math, index) => {
                const placeholder = `MATHPLACEHOLDER${index}MATHPLACEHOLDER`;
                htmlContent = htmlContent.replace(new RegExp(`<p>${placeholder}</p>`, 'g'), math);
                htmlContent = htmlContent.replace(new RegExp(placeholder, 'g'), math);
            });
            
            return htmlContent;
        }
        
        function collapseAllDetails(containerId) {
            document.querySelectorAll(`#${containerId} details`).forEach(detail => detail.open = false);
        }

        function expandAllDetails(containerId) {
            document.querySelectorAll(`#${containerId} details`).forEach(detail => detail.open = true);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        });
    </script>
</body>
</html>


